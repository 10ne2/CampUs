<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Mail-Mapper">
	<sql id="search">
	  <if test="keyword != null and keyword != ''">
	    AND (
	      sender.mem_name LIKE '%' || #{keyword} || '%'
	      OR receiver.mem_name LIKE '%' || #{keyword} || '%'
	      OR m.mail_sender LIKE '%' || #{keyword} || '%'
	      OR m.mail_receiver LIKE '%' || #{keyword} || '%'
	      OR sender.mem_email LIKE '%' || #{keyword} || '%'
	      OR receiver.mem_email LIKE '%' || #{keyword} || '%'
	      OR m.mail_name LIKE '%' || #{keyword} || '%'
	    )
	  </if>
	</sql>
	<select id="selectSearchMailList" parameterType="pageMaker" resultType="mail">
		select
			m.mail_id,
		  	m.mail_name,
		    m.mail_sdate,
		    m.mail_rdate,
		    m.mail_read,
		    m.mail_important,
		    m.mail_desc,
		    m.mail_sender,
		    sender.mem_name AS sender_name,
		    sender.mem_email AS sender_email,
		    m.mail_receiver,
		    receiver.mem_name AS receiver_name,
		    receiver.mem_email AS receiver_email
		from mail m
		JOIN account sender ON m.mail_sender = sender.mem_id
  		JOIN account receiver ON m.mail_receiver = receiver.mem_id
		where (m.mail_sender = #{mem_id} OR m.mail_receiver = #{mem_id})  			  	
		<include refid="search" />
		order by GREATEST(m.mail_sdate, m.mail_rdate) desc
	</select>
	<select id="selectSearchMailListCount" parameterType="pageMaker" resultType="int">
		select
		count(*)
		from mail m
		JOIN account sender ON m.mail_sender = sender.mem_id
  		JOIN account receiver ON m.mail_receiver = receiver.mem_id
		where (m.mail_sender = #{mem_id} OR m.mail_receiver = #{mem_id})  			  	
		<include refid="search" />
	</select>
	<select id="selectMailByMailId" parameterType="int" resultType="mail">
		select
			m.mail_id,
		  	m.mail_name,
		    m.mail_sdate,
		    m.mail_rdate,
		    m.mail_read,
		    m.mail_important,
		    m.mail_desc,
		    m.mail_sender,
		    sender.mem_name AS sender_name,
		    sender.mem_email AS sender_email,
		    m.mail_receiver,
		    receiver.mem_name AS receiver_name,
		    receiver.mem_email AS receiver_email
		from mail m
		JOIN account sender ON m.mail_sender = sender.mem_id
  		JOIN account receiver ON m.mail_receiver = receiver.mem_id
		WHERE m.mail_id = #{mail_id}
	</select>
	<select id="selectUnreadReceiverCount" parameterType="String" resultType="int">
		select
		count(*)
		from mail
		WHERE mail_receiver = #{mem_id} and mail_read = 0
	</select>
	<insert id="insertMail" parameterType="mail"> 
		insert into 
		mail(mail_sender, mail_receiver, mail_name, mail_desc)
  		values(#{mail_sender}, #{mail_receiver}, #{mail_name}, #{mail_desc})
	</insert>
	<delete id="deleteMail" parameterType="int" >
		delete 
		from mail 
		where mail_id=#{mail_id}
	</delete>

</mapper>





